<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TOEIC Part 2 Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <audio id="audio" controls class="fixed top-4 right-4 z-50">
    <source src="audio.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-3xl font-bold text-center mb-6">TOEIC Part 2 Quiz</h1>

    <div id="admin-controls" class="mb-6 hidden">
      <div id="participant-count" class="text-lg font-semibold mb-4"></div>
      <button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Bắt đầu làm bài</button>
      <button id="endBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden">Kết thúc</button>
      <div id="results-table" class="mt-6 hidden">
        <h2 class="text-xl font-bold mb-4">Kết quả</h2>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200">
              <th class="border p-2">Tên</th>
              <th class="border p-2">Điểm</th>
              <th class="border p-2">Thời gian nộp</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
    </div>

    <form id="quizForm" class="hidden">
      <div class="mb-6">
        <h2 class="text-xl font-bold">Phần 1</h2>
        <p class="text-gray-600 mb-4">Câu hỏi từ 7 đến 31 (Phần 1)</p>
        <div id="section1" class="space-y-4"></div>
      </div>
      <div class="mb-6">
        <h2 class="text-xl font-bold">Phần 2</h2>
        <p class="text-gray-600 mb-4">Câu hỏi từ 7 đến 31 (Phần 2)</p>
        <div id="section2" class="space-y-4"></div>
      </div>
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Nộp bài</button>
    </form>

    <div id="notification" class="mt-4 text-lg"></div>
  </div>

  <script>
    const username = prompt("Nhập tên của bạn:") || 'Học sinh';
    const isAdmin = username.toLowerCase() === 'admin';
    const startBtn = document.getElementById("startBtn");
    const endBtn = document.getElementById("endBtn");
    const quizForm = document.getElementById("quizForm");
    const notification = document.getElementById("notification");
    const section1 = document.getElementById("section1");
    const section2 = document.getElementById("section2");
    const adminControls = document.getElementById("admin-controls");
    const participantCount = document.getElementById("participant-count");
    const resultsTable = document.getElementById("results-table");
    const resultsBody = document.getElementById("results-body");

    const wsProtocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(wsProtocol + location.host);

    const createQuestion = (id, text, section) => {
      const div = document.createElement("div");
      div.className = "bg-gray-50 p-4 rounded border";
      div.innerHTML = `
        <label class="font-semibold">${text} (Phần ${section})</label>
        <div class="mt-2 space-y-2">
          <label class="block"><input type="radio" name="${id}" value="A" class="mr-2"> A</label>
          <label class="block"><input type="radio" name="${id}" value="B" class="mr-2"> B</label>
          <label class="block"><input type="radio" name="${id}" value="C" class="mr-2"> C</label>
          <label class="block"><input type="radio" name="${id}" value="D" class="mr-2"> D</label>
        </div>
      `;
      return div;
    };

    for (let i = 7; i <= 31; i++) {
      section1.appendChild(createQuestion(`q${i}`, `Câu ${i}`, 1));
      section2.appendChild(createQuestion(`q${i}_2`, `Câu ${i}`, 2));
    }

    if (isAdmin) {
      adminControls.classList.remove("hidden");
      startBtn.onclick = () => {
        socket.send(JSON.stringify({ type: "start" }));
        startBtn.classList.add("hidden");
        endBtn.classList.remove("hidden");
      };
      endBtn.onclick = () => {
        socket.send(JSON.stringify({ type: "end" }));
        endBtn.disabled = true;
        fetchResults();
      };
    } else {
      quizForm.classList.add("hidden");
    }

    socket.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "start") {
        if (!isAdmin) quizForm.classList.remove("hidden");
      }
      if (msg.type === "end") {
        quizForm.querySelectorAll('input').forEach(input => input.disabled = true);
        notification.innerText = 'Quiz đã kết thúc. Bạn không thể thay đổi câu trả lời nữa.';
        if (isAdmin) {
          resultsTable.classList.remove("hidden");
          fetchResults();
        }
      }
      if (msg.type === "submitted") {
        const who = msg.username === username ? "Bạn" : msg.username;
        notification.innerText = `${who} đã nộp bài.`;
      }
      if (msg.type === "participantCount") {
        if (isAdmin) {
          participantCount.innerText = `Số người tham gia: ${msg.count}`;
        }
      }
    };

    async function fetchResults() {
      const res = await fetch("/results");
      const results = await res.json();
      resultsBody.innerHTML = "";
      results.forEach(result => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border p-2">${result.username}</td>
          <td class="border p-2">${result.score}/50</td>
          <td class="border p-2">${new Date(result.timestamp).toLocaleString()}</td>
        `;
        resultsBody.appendChild(tr);
      });
    }

    quizForm.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(quizForm);
      const answers = {};
      formData.forEach((val, key) => answers[key] = val);
      const res = await fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, answers })
      });
      const result = await res.json();
      notification.innerText = `Bạn được ${result.score}/50.`;
      socket.send(JSON.stringify({ type: "submitted", username }));
      quizForm.querySelector("button[type=submit]").disabled = true;
    };
  </script>
</body>
</html>